<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maison Izon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --accent: #00d1ff; --bs-dark-rgb: 255,255,255;}
        body { background-color: #000; margin: 0; overflow: hidden; font-family: sans-serif; color: white; }
        #side-menu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: rgba(20,20,20,0.95); z-index: 2000; transition: 0.3s; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #side-menu.open { left: 0; }
        #rooms-list { padding: 10px; overflow-y: auto; flex-grow: 1; }
        .room-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; display: flex; align-items: center; justify-content: space-between; }
        .room-item.active { background: var(--accent); color: black; font-weight: bold; }
        .room-status-icons { display: flex; gap: 15px; font-size: 0.9rem; opacity: 0.7; }
        .room-status-icons .fa-robot { cursor: pointer; }
        .room-status-icons .fa-door-open { color: #f59e0b; }
        #top-info { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; text-align: center; pointer-events: none; }
        #room-name { font-weight: bold; font-size: 1.2rem; color: var(--accent); text-transform: uppercase; }
        #plan-wrapper { position: relative; height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; }
        #panorama { position: absolute; width: 100%; height: 100%; display: none; z-index: 500; }
        #plan-container { position: relative; z-index: 10; }
        #plan-img { max-height: 85vh; max-width: 95vw; display: block; user-select: none; }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        svg.edit-active { pointer-events: all !important; }
        .zone-poly { fill: var(--accent); fill-opacity: 0.1; stroke: var(--accent); stroke-width: 1; cursor: pointer; pointer-events: all; }
        .zone-poly:hover { fill-opacity: 0.4; stroke: white; stroke-width: 2; }
        #draw-line { stroke: #ff4444; stroke-width: 2; fill: rgba(255, 68, 68, 0.2); stroke-dasharray: 5; pointer-events: none; }
        .btn-menu { position: fixed; top: 20px; left: 20px; z-index: 2100; background: rgba(0,0,0,0.6); border: 1px solid var(--accent); color: white; border-radius: 50%; width: 45px; height: 45px; }
        .ui-controls { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        #ha-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; height: 600px; background: #1c1c1c; border-radius: 20px; z-index: 3000; border: 1px solid #444; }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2999; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 30px; color: white; cursor: pointer; }
        .custom-hotspot { height: 25px; width: 25px; background: rgba(0, 209, 255, 0.7); border: 2px solid white; border-radius: 50%; cursor: pointer; }
        #weather-widget { padding: 20px; text-align: center; border-bottom: 1px solid #333; }
    </style>
</head>
<body>

<div id="side-menu">
    <div id="weather-widget">Chargement...</div>
    <div id="rooms-list"></div>
</div>

<button class="btn-menu" onclick="document.getElementById('side-menu').classList.toggle('open')"><i class="fas fa-bars"></i></button>

<div id="top-info">
    <h1 style="font-size: 1.5rem; color: #fff; text-shadow: 0 0 5px var(--accent);">Maison Izon</h1>
    <div id="room-name">...</div>
    <div id="temp-badge" class="badge bg-dark border border-info mt-1">--Â°C</div>
</div>

<div class="ui-controls">
    <button id="btn-toggle-360" class="btn btn-info btn-sm rounded-pill fw-bold px-3 shadow" onclick="toggle360View()">VUE 360Â°</button>
    <button id="btn-edit" class="btn btn-warning btn-sm rounded-pill" onclick="toggleEdit()">Ã‰DIT</button>
</div>

<div id="plan-wrapper">
    <div id="plan-container">
        <img id="plan-img" src="" alt="Plan de la maison" ondragstart="return false;">
        <svg id="svg-overlay" onclick="handleMapClick(event)"></svg>
    </div>
    <div id="panorama"></div>
</div>

<div id="modal-overlay" onclick="closeModal()"></div>
<div id="ha-modal">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <iframe id="ha-frame" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 20px;"></iframe>
</div>

<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Configurer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-idx">
                <input type="hidden" id="edit-type">
                <div class="mb-3">
                    <label for="zone-name" class="form-label">Nom</label>
                    <input type="text" class="form-control form-control-sm bg-dark text-white" id="zone-name">
                </div>
                <div class="mb-3">
                    <label for="zone-url" class="form-label">URL / EntitÃ©</label>
                    <input type="text" class="form-control form-control-sm bg-dark text-white" id="zone-url">
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteItem()">Supprimer</button>
                <button type="button" class="btn btn-success btn-sm" onclick="confirmItem()">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<script>
let HA_URL, TOKEN, WEATHER_ENTITY, ROOMS = [];
let curR = 0, zones = [], hotspots = [], currentPoints = [], editMode = false, is360Active = false, panoViewer = null;
const configModal = new bootstrap.Modal(document.getElementById('configModal'));
const svgOverlay = document.getElementById('svg-overlay');
const drawLine = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
drawLine.setAttribute("id", "draw-line");
svgOverlay.appendChild(drawLine);

async function loadConfig() {
    try {
        const res = await fetch('config.json');
        if (!res.ok) throw new Error("config.json not found");
        const config = await res.json();
        HA_URL = config.ha_url;
        TOKEN = config.ha_token;
        WEATHER_ENTITY = config.weather_entity;
        ROOMS = config.rooms || [];
        return true;
    } catch (e) {
        console.error("Failed to load global config:", e);
        document.body.innerHTML = `<div style="padding:20px; color:red;">Erreur: Impossible de charger config.json. VÃ©rifiez que le fichier existe et est accessible.</div>`;
        return false;
    }
}

async function callService(service, entity_id, data = {}) {
    if(!entity_id || !HA_URL) return;
    const [domain, action] = service.split('.');
    try {
        await fetch(`${HA_URL}/api/services/${domain}/${action}`, { 
            method: 'POST', 
            headers: { "Authorization": `Bearer ${TOKEN}`, "Content-Type": "application/json" },
            body: JSON.stringify({ entity_id, ...data }) 
        });
    } catch(e) { console.error(`Failed to call service ${service} for ${entity_id}`, e); }
}

async function getEntityState(entity_id) {
    if (!entity_id || !HA_URL) return null;
    try {
        const res = await fetch(`${HA_URL}/api/states/${entity_id}`, {
            headers: { "Authorization": `Bearer ${TOKEN}` }
        });
        if (!res.ok) return null;
        return await res.json();
    } catch (e) { return null; }
}

function initMenu() {
    if (!ROOMS.length) return;
    document.getElementById('rooms-list').innerHTML = ROOMS.map((r, i) => `
        <div class="room-item ${i === curR ? 'active' : ''}" onclick="switchRoom(${i}); document.getElementById('side-menu').classList.remove('open');">
            <span><i class="fas fa-door-closed me-2"></i>${r.n}</span>
            <div class="room-status-icons">
                ${r.vacuum_entity ? `<i class="fas fa-robot" onclick="event.stopPropagation(); callService('button.press', '${r.vacuum_entity}');"></i>` : ''}
                ${r.window_entity ? `<i id="win-status-${i}" class="fas fa-question-circle"></i>` : ''}
            </div>
        </div>`).join('');
}

async function updateAllStatuses() {
    if (!WEATHER_ENTITY) return;
    const weatherState = await getEntityState(WEATHER_ENTITY);
    if (weatherState) {
        document.getElementById('weather-widget').innerHTML = `
            <h5>MÃ©tÃ©o Ã  Izon</h5>
            <div class="fs-3 fw-bold">${weatherState.attributes.temperature || '--'}Â°C</div>
            <div>${weatherState.state || '--'}</div>`;
    }

    for(let i=0; i < ROOMS.length; i++){
        const room = ROOMS[i];
        if(room.window_entity){
            const windowState = await getEntityState(room.window_entity);
            const icon = document.getElementById(`win-status-${i}`);
            if(windowState && icon){
                icon.className = `fas ${windowState.state === 'on' ? 'fa-door-open text-warning' : 'fa-door-closed'}`;
            }
        }
    }
}

async function switchRoom(idx) {
    if (!ROOMS[idx]) return;
    curR = idx; 
    const r = ROOMS[curR];
    document.getElementById('room-name').innerText = r.n;
    document.getElementById('plan-img').src = r.img;
    document.getElementById('btn-toggle-360').style.display = r.img360 ? 'block' : 'none';
    initMenu();
    
    try {
        const [res2d, res360, t] = await Promise.all([
            r.var_2d ? getEntityState(r.var_2d) : Promise.resolve(null),
            r.var_360 ? getEntityState(r.var_360) : Promise.resolve(null),
            getEntityState(r.temp)
        ]);

        // PrioritÃ© Ã  l'attribut 'data' pour contourner la limite de 255 caractÃ¨res de l'Ã©tat HA
        const zonesStr = res2d?.attributes?.data || res2d?.state;
        const hotspotsStr = res360?.attributes?.data || res360?.state;

        try {
            zones = (zonesStr && zonesStr !== 'unknown' && zonesStr !== 'unavailable') ? JSON.parse(zonesStr) : [];
        } catch(e) { zones = []; console.warn("Format zones invalide", e); }

        try {
            hotspots = (hotspotsStr && hotspotsStr !== 'unknown' && hotspotsStr !== 'unavailable') ? JSON.parse(hotspotsStr) : [];
        } catch(e) { hotspots = []; console.warn("Format hotspots invalide", e); }

        document.getElementById('temp-badge').innerText = t ? `${t.state || '--'}Â°C` : '--Â°C';

    } catch(e) {
        console.error("Erreur de chargement de la piÃ¨ce:", e);
        zones = []; hotspots = [];
    }
    
    is360Active = false;
    document.getElementById('panorama').style.display = 'none';
    document.getElementById('plan-container').style.display = 'block';
    syncSVG();
}

async function saveToJSON(type = 'both') {
    const r = ROOMS[curR];

    try {
        if ((type === 'zones' || type === 'both') && r.var_2d) {
            await callService('var.set', r.var_2d, {
                value: "Mis Ã  jour le " + new Date().toLocaleString(),
                attributes: { data: JSON.stringify(zones) }
            });
        }

        if ((type === 'hotspots' || type === 'both') && r.var_360) {
            await callService('var.set', r.var_360, {
                value: "Mis Ã  jour le " + new Date().toLocaleString(),
                attributes: { data: JSON.stringify(hotspots) }
            });
        }

        console.log("Sauvegarde Home Assistant rÃ©ussie");
    } catch (e) {
        alert("ðŸš¨ Ã‰CHEC DE SAUVEGARDE SUR HOME ASSISTANT\n\n" + e.message + "\n\nVÃ©rifiez que l'intÃ©gration 'var' est installÃ©e et que les entitÃ©s existent.");
        console.error("Save error:", e);
    }
}

function toggle360View() {
    is360Active = !is360Active;
    document.getElementById('panorama').style.display = is360Active ? 'block' : 'none';
    document.getElementById('plan-container').style.display = is360Active ? 'none' : 'block';
    document.getElementById('btn-toggle-360').innerText = is360Active ? "PLAN 2D" : "VUE 360Â°";
    if (is360Active) initPannellum();
}

function syncSVG() { 
    const img = document.getElementById('plan-img'); 
    if(!img || !img.clientWidth) return;
    svgOverlay.setAttribute("viewBox", `0 0 ${img.clientWidth} ${img.clientHeight}`); 
    svgOverlay.style.width = img.clientWidth + "px"; 
    svgOverlay.style.height = img.clientHeight + "px"; 
    drawZones(); 
}

function handleMapClick(e) { 
    if(!editMode || is360Active) return; 
    const img = document.getElementById('plan-img'); 
    const rect = img.getBoundingClientRect(); 
    const x = Math.round(((e.clientX - rect.left) / rect.width) * 100); 
    const y = Math.round(((e.clientY - rect.top) / rect.height) * 100); 
    currentPoints.push(`${x},${y}`); 
    updateDrawLine(); 
}

function updateDrawLine() { 
    const img = document.getElementById('plan-img'); 
    if (!img) return;
    const rect = img.getBoundingClientRect(); 
    const pts = currentPoints.map(p => { const [px, py] = p.split(','); return `${(px * rect.width) / 100},${(py * rect.height) / 100}`; }).join(' '); 
    drawLine.setAttribute("points", pts); 
}

window.onkeydown = (e) => { 
    if(e.key === "Enter" && currentPoints.length > 2) { 
        zones.push({ n: "Nouveau", p: currentPoints.join(' '), u: "" }); 
        currentPoints = []; 
        drawLine.setAttribute("points", ""); 
        drawZones(); 
        openConfig(zones.length - 1, '2D'); 
    } 
};

function drawZones() { 
    while (svgOverlay.childNodes.length > 1) {
        svgOverlay.removeChild(svgOverlay.lastChild);
    }

    zones.forEach((z, i) => { 
        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon"); 
        const img = document.getElementById('plan-img');
        const pts = z.p.split(' ').map(p => { 
            const [px, py] = p.split(','); 
            return `${px * img.clientWidth / 100},${py * img.clientHeight / 100}`; 
        }).join(' '); 
        poly.setAttribute("points", pts); 
        poly.setAttribute("class", "zone-poly"); 
        poly.onclick = (e) => { e.stopPropagation(); editMode ? openConfig(i, '2D') : handleAction(z); }; 
        svgOverlay.appendChild(poly); 
    }); 
}

function initPannellum() { 
    if(panoViewer) panoViewer.destroy(); 
    if (!ROOMS[curR].img360) return;
    panoViewer = pannellum.viewer('panorama', { 
        "type": "equirectangular", 
        "panorama": ROOMS[curR].img360, 
        "autoLoad": true, 
        "showControls": false, 
        "hotSpots": hotspots.map((h, i) => ({ 
            pitch: parseFloat(h.pi), 
            yaw: parseFloat(h.y), 
            cssClass: 'custom-hotspot', 
            clickHandlerFunc: () => editMode ? openConfig(i, '360') : handleAction(h) 
        })) 
    }); 
    panoViewer.on('mousedown', (e) => { 
        if(!editMode) return; 
        const c = panoViewer.mouseEventToCoords(e); 
        if(c) { 
            hotspots.push({ n: "Point", pi: Math.round(c[0]), y: Math.round(c[1]), u: "" }); 
            initPannellum(); 
            setTimeout(() => openConfig(hotspots.length - 1, '360'), 200); 
        } 
    }); 
}

function toggleEdit() { 
    editMode = !editMode; 
    document.getElementById('btn-edit').innerText = editMode ? "FINIR" : "Ã‰DIT"; 
    svgOverlay.classList.toggle('edit-active', editMode); 
    currentPoints = []; 
    updateDrawLine(); 
}

function openConfig(idx, type) { 
    document.getElementById('edit-idx').value = idx; 
    document.getElementById('edit-type').value = type; 
    const item = (type === '360') ? hotspots[idx] : zones[idx]; 
    document.getElementById('zone-name').value = item.n; 
    document.getElementById('zone-url').value = item.u; 
    configModal.show(); 
}

function confirmItem() { 
    const i = document.getElementById('edit-idx').value; 
    const type = document.getElementById('edit-type').value; 
    const item = (type === '360') ? hotspots[i] : zones[i]; 
    item.n = document.getElementById('zone-name').value; 
    item.u = document.getElementById('zone-url').value; 
    configModal.hide(); 
    if (is360Active) initPannellum(); else drawZones(); 
    saveToJSON(type === '360' ? 'hotspots' : 'zones');
}

function deleteItem() { 
    const i = document.getElementById('edit-idx').value; 
    const type = document.getElementById('edit-type').value;
    if(type === '360') {
        hotspots.splice(i, 1); 
    } else { 
        zones.splice(i, 1); 
    } 
    configModal.hide(); 
    if (is360Active) initPannellum(); else drawZones(); 
    saveToJSON(type === '360' ? 'hotspots' : 'zones');
}

async function handleAction(item) { 
    const url = item.u || item.url; 
    if(!url) return; 
    if(url.includes('.') && !url.includes('/')) { 
        await callService('homeassistant.toggle', url); 
    } else { 
        document.getElementById('ha-frame').src = url; 
        document.getElementById('ha-modal').style.display = 'block'; 
        document.getElementById('modal-overlay').style.display = 'block'; 
    } 
}

function closeModal() { 
    document.getElementById('ha-modal').style.display='none'; 
    document.getElementById('modal-overlay').style.display='none'; 
    document.getElementById('ha-frame').src = 'about:blank';
}

(async () => {
    const ok = await loadConfig();
    if (ok && ROOMS.length > 0) {
        await switchRoom(0);
        updateAllStatuses();
        setInterval(updateAllStatuses, 30000);
    }
    window.onresize = syncSVG;
    document.getElementById('plan-img').onload = syncSVG;
})();
</script>
</body>
</html>